pipeline {
    agent none

    environment {
        DOCKER_HUB_USER = credentials('docker-hub-login')
    }

    stages {
        stage("build") {
            when {
                anyOf {
                    changeRequest()
                    changeset "**/result/**"
                }
            }
            agent {
                docker {
                    image "node:lts-alpine"
                    args '-v $HOME/.npm:/root/.npm'
                }
            }
            steps {
                echo 'Compiling result app'
                dir('result') {
                    sh 'npm install'
                    sh 'npm ls'
                }
            }
        }
        stage("test") {
            when {
                anyOf {
                    changeRequest()
                    changeset "**/result/**"
                }
            }
            agent {
                docker {
                    image "node:lts-alpine"
                    args '-v $HOME/.npm:/root/.npm'
                }
            }
            steps {
                echo 'Running tests'
                dir('result') {
                    sh 'npm install'
                    sh 'npm test'
                }
            }
        }
        stage("docker-package") {
            when {
                allOf {
                    branch "master"
                    changeset "**/result/**"
                }
            }
            agent any
            steps {
                echo 'Building Docker image'
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'docker-hub-credentials') {
                        def image = docker.build("${DOCKER_HUB_USER}/result:v${env.BUILD_ID}", "./result")

                        try {
                            image.push()
                            image.push("latest")
                        } finally {
                            sh "docker rmi ${DOCKER_HUB_USER}/result:v${env.BUILD_ID}"
                            sh "docker rmi ${DOCKER_HUB_USER}/result:latest"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Building multibranch pipeline for result is completed.'
            script {
                node() { // need node here due to top node set to none
                    sh 'docker image prune -f'
                }
            }
        }
        failure {
            slackSend (channel: "#ci-cd", message: "Build Failed: ${env.JOB_NAME} ${env.BUILD_NUMBER}")
        }
        success {
            slackSend (channel: "#ci-cd", message: "Build Success: ${env.JOB_NAME} ${env.BUILD_NUMBER}")
        }
    }
}
